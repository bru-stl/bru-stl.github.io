<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
</head>

<style>
    body {
        padding: 0;
        margin: 0;
    }
    html, body, #map {
        height: 100%;
        width: 100vw;
    }
</style>

<body>
    <div id="map"></div>
</body>

<script>
    const survey_url = 'https://airtable.com/shr3X3r4hnezHykAt'
    const prefill_stopid = '?prefill_StopId='
    const prefill_stopname = '&prefill_Stop+Name='

    var map = L.map('map').fitWorld();
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 17,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: 'pk.eyJ1IjoibWVhZ2xlcyIsImEiOiJjbDE2bHNxeGcxM3U0M2V2MGFrdmVpZjdlIn0._KTpXGwEcFTSE50BjYKcJg'
    }).addTo(map);

    // Geolocate
    map.locate({setView: true, maxZoom: 17})
    function onLocationFound(e) {
        var radius = e.accuracy;

        // Add nearby stops to map
        let stops_url = '/data/stl-gtfs/stops.txt'
        fetch(stops_url)
            .then(response => response.text())
            .then(data => {
                let rows = data.split('\n');
                for (let i = 1; i < rows.length; i++) {
                    let data_parts = rows[i].split(',');
                    let thisStopLatLng = L.latLng(data_parts[0], data_parts[3]);
                    // lat, wheelchair_boarding, zone_id, lon, stop_id, stop_desc, stop_name, location_type, stop_code
                    if (thisStopLatLng && thisStopLatLng.distanceTo(e.latlng) < 800) {
                        let thisMarker = L.marker(thisStopLatLng, {title: data_parts[6]}).addTo(map);
                        thisMarker.on('click', () => { window.open(survey_url.concat(prefill_stopid, data_parts[4], prefill_stopname, data_parts[6]), '_blank') })
                    }
                }
            });

        // L.marker(e.latlng).addTo(map)
            // .bindPopup("You are within " + radius + " meters from this point").openPopup();

        L.circle(e.latlng, radius).addTo(map);
    }
    map.on('locationfound', onLocationFound);   
</script>